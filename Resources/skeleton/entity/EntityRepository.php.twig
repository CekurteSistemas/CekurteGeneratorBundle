<?php

namespace {{ namespace }}\Entity\Repository;

{% block use_statements %}
use Doctrine\ORM\EntityRepository;
use {{ namespace }}\Entity\{{ entity_class }};
{% endblock use_statements %}

/**
 * {{ entity_class }} Repository.
 *
 * @author JoÃ£o Paulo Cercal <sistemas@cekurte.com>
 * @version 0.1
 */
{% block class_definition %}
class {{ entity_class }}Repository extends EntityRepository
{% endblock class_definition %}
{
{% block class_body %}
    /**
     * Search for records based on an entity
     *
     * @param {{ entity_class }} $entity
     * @param string $sort
     * @param string $direction
     * @return \Doctrine\ORM\Query
{% include 'crud/actions/author.php.twig' %}
     */
    public function getQuery({{ entity_class }} $entity, $sort, $direction)
    {
        $queryBuilder = $this->createQueryBuilder('ck');

        $data = array(
    {% for field in fields %}
        '{{ field.columnName }}' => $entity->get{{ field.fieldName|first|upper }}{{ field.fieldName|slice(1) }}(),
    {% endfor %}
    );

        {%- for field in fields %}


        if (!empty($data['{{ field.columnName }}'])) {
            {% if field.type == 'date' or field.type == 'datetime' -%}
            $queryBuilder

                ->andWhere($queryBuilder->expr()->between(
                    'ck.{{ field.columnName }}',
                    ':{{ field.columnName }}_from',
                    ':{{ field.columnName }}_to'
                ))
                ->setParameter('{{ field.columnName }}_from', $data['{{ field.columnName }}'])
                ->setParameter('{{ field.columnName }}_to', $data['{{ field.columnName }}'])
            ;
            {%- elseif field.type == 'string' -%}

                {%- if field.length <= 2 -%}
            $queryBuilder
                ->andWhere($queryBuilder->expr()->eq('ck.{{ field.columnName }}', ':{{ field.columnName }}'))
                ->setParameter('{{ field.columnName }}', $data['{{ field.columnName }}'])
            ;

                {%- else -%}
            $queryBuilder
                ->andWhere($queryBuilder->expr()->like('ck.{{ field.columnName }}', ':{{ field.columnName }}'))
                ->setParameter('{{ field.columnName }}', "%{$data['{{ field.columnName }}']}%")
            ;

                {%- endif %}
            {% else -%}
            $queryBuilder
                ->andWhere($queryBuilder->expr()->eq('ck.{{ field.columnName }}', ':{{ field.columnName }}'))
                ->setParameter('{{ field.columnName }}', $data['{{ field.columnName }}'])
            ;

            {%- endif %}

        }
        {%- endfor %}


        return $queryBuilder
            ->orderBy($sort, $direction)
            ->getQuery()
        ;
    }
{% endblock class_body %}
}
